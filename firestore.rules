rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isSignedIn() {
      return request.auth != null;
    }

    // Helper function to get user's role from their profile
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Helper function to check if user is super admin
    function isSuperAdmin() {
      return isSignedIn() && getUserRole() == 'super_admin';
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isSignedIn() && getUserRole() == 'admin';
    }

    // Helper function to check if user is admin or super admin
    function isAdminOrSuperAdmin() {
      return isSignedIn() && (getUserRole() == 'admin' || getUserRole() == 'super_admin');
    }

    // Users collection - profiles
    match /users/{userId} {
      // Users can create their own profile during signup
      allow create: if isSignedIn() && request.auth.uid == userId;

      // Users can read/update their own profile
      allow read, update: if isSignedIn() && request.auth.uid == userId;

      // Super admin can read/write all users
      allow read, write: if isSuperAdmin();

      // Admin can read all users (domain checks should be applied in app logic)
      allow read: if isAdmin();
    }

    // Admin approval documents
    match /approval_documents/{documentId} {
      // Anyone can create (allow public submissions)
      allow create: if true;

      // Authenticated users may read their own submissions
      allow read: if isSignedIn() && resource.data.email == request.auth.token.email;

      // Super admin can read and update all approval documents
      allow read, update: if isSuperAdmin();
    }

    // Audit logs
    match /audit_logs/{logId} {
      // Anyone authenticated (or server) may create an audit log
      allow create: if isSignedIn();

      // Users can read their own logs
      allow read: if isSignedIn() && resource.data.userId == request.auth.uid;

      // Admins / super_admin can read all logs
      allow read: if isAdminOrSuperAdmin();

      // Prevent client-side updates or deletes of logs (logs should be append-only)
      allow update, delete: if isSuperAdmin();
    }

    // Alerts
    match /alerts/{alertId} {
      // Only admin/super_admin may set alerts for 'all' recipients;
      // normal users can only create alerts for themselves
      allow create: if isSignedIn() && (
        (request.resource.data.userId == request.auth.uid) ||
        (isAdminOrSuperAdmin())
      );

      // User can read alerts targeted at them, or public ('all')
      allow read: if isSignedIn() && (resource.data.userId == request.auth.uid || resource.data.userId == 'all');

      // Admins / super_admin can read all alerts and manage them
      allow read, update, delete: if isAdminOrSuperAdmin();
    }

    // Policies
    match /policies/{policyId} {
      allow read: if isSignedIn();
      allow create, update, delete: if isAdminOrSuperAdmin();
    }

    // Shared data/files collection
    match /shared_data/{dataId} {
      // Creation: authenticated (or server) may create file metadata
      allow create: if isSignedIn();

      // Read: owner OR listed in `sharedWith` OR public (no sharedWith field)
      allow read: if isSignedIn() && (
        resource.data.ownerId == request.auth.uid ||
        (resource.data.sharedWith is list && request.auth.uid in resource.data.sharedWith) ||
        resource.data.sharedWith == null
      );

      // Update/delete: owner or admin
      allow update, delete: if isSignedIn() && (resource.data.ownerId == request.auth.uid || isAdminOrSuperAdmin());
    }

    // Per-user login counters
    match /user_logins/{userId} {
      // Creation/update: user may update their own login counter document
      allow create, update: if isSignedIn() && (request.auth.uid == userId || isAdminOrSuperAdmin());

      // Read: owner or admins can read
      allow read: if isSignedIn() && (request.auth.uid == userId || isAdminOrSuperAdmin());

      // Prevent client-side deletes
      allow delete: if isSuperAdmin();
    }

    // Fallback: deny everything else
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
